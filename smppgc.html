<html>
  <head>
  </head>
  <body>
    <h1>smppgc</h1>
    <label>username: </label>
    <input id="username_field" type="text">
    <button id="connectbtn">Connect</button>
    <div id="mesgs"></div>
    <div id="pending_mesgs" style="color: gray;"></div>
    <input maxlength="30" id="sendinput" type="text">
    <button id="sendbtn">Send</button>
    <script>
      const CLOSED=3;
      const SUBID_SETUP=0;
      const SUBID_USERJOIN=1;
      let local_id = undefined;
      let local_key = "";
      let local_name = "name";
      let users = {};

      const sendbtn = document.getElementById("sendbtn");
      const sendinput = document.getElementById("sendinput");
      const mesgs = document.getElementById("mesgs");
      const pending_mesgs = document.getElementById("pending_mesgs");
      const username_field = document.getElementById("username_field");
      const connectbtn = document.getElementById("connectbtn");

      async function on_special_message(sub_id, data, dv, start_index){
        switch(sub_id){
          case SUBID_SETUP:
            local_id = dv.getUint16(start_index, false);
            local_key = await data.slice(start_index+2).text();
            console.log("Setup packet "+local_id+" "+local_key);
            break;
          case SUBID_USERJOIN:
            let id = dv.getUint16(start_index, false);
            let username = await data.slice(start_index+2).text()
            console.log("user join: "+username+" ("+id+")");
            users[id] = username;
            break;
          default:
            console.error("Invalid subid ("+sub_id+") packet recieved");
            break;
        }

      }

      function on_message(message, sender){
        console.log("Got message from "+sender+" : "+message);
        let username = users[sender];
        if (sender == local_id){ // message comes from me
          username = local_name;
          let mesgs = pending_mesgs.childNodes;
          for (let i=0; i<mesgs.length; i++){
            let mesg = mesgs[i];
            if (mesg.innerText == message){
              pending_mesgs.remove(mesg);
              break;
            }
          }
        }

        let username_el = document.createElement("span");
        username_el.style="font-weight: bold;";
        username_el.innerText=username+": ";
        let content_el = document.createElement("span");
        content_el.innerText=message;

        let msg_el = document.createElement("div");
        msg_el.appendChild(username_el);
        msg_el.appendChild(content_el);
        mesgs.appendChild(msg_el);
      }

      function connect(key, username){
        let query=username;
        if (key !== undefined && key !== ""){
          query+="&"+key;
        }
        const ws = new WebSocket("ws://localhost:8080/smpp/gc/socket?"+query);

        ws.onmessage = async (e) =>{
          let data = e.data;
          if (data instanceof Blob){
            let dv = new DataView(await e.data.slice(0, 5).arrayBuffer())
            const sender_id = dv.getUint16(0, false);
            if (sender_id == 0){ // user 0 is special message
              let sub_id = dv.getUint8(2, false);
              await on_special_message(sub_id, e.data, dv, 3);
            }else{
              let message = await e.data.slice(2).text();
              on_message(message, sender_id);
            }
          }
        };
        ws.onopen = async (e) => {
          connectbtn.innerText = "Reconnect";
        }
        ws.onclose = async (e) => {
          connectbtn.innerText = "Connect";
          console.log(e);
        }

        return ws
      }

      let ws = undefined;
      connectbtn.addEventListener("click", ()=>{
        if (ws !== undefined){
          ws.close();
        }
        mesgs.innerHTML="";
        pending_mesgs.innerHTML="";
        local_name = username_field.value;
        users = {};
        ws = connect(local_key, local_name);
      });
      sendinput.addEventListener("keypress", (e)=>{
        if (e.key == "Enter"){
          e.preventDefault();
          sendbtn.click();
        }
      });
      sendbtn.addEventListener("click", ()=>{
        ws.send(sendinput.value);
        let msg = document.createElement("P");
        msg.innerText=sendinput.value;
        pending_mesgs.appendChild(msg);
        sendinput.value="";
      });
    </script>
  </body>
</html>
